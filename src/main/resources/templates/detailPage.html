<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>End to End Workflow</title>
<link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
	<h1>
		Detail Page for Story: <span th:text="${storyNumber}"></span>
	</h1>
	<div class="header">
		<div class="header-left">
			<h1>MN End to End Workflow</h1>
		</div>
		<div class="header-right">
			<span class="user-name" id="user-name">Loading...</span><br> <span
				class="user-role">Role (Analyst)</span>
		</div>
	</div>

	<div class="container">
		<div class="sidebar">
			<button class="menu-button" onclick="showSection('changeFile')">Change
				File Generator</button>
			<button class="menu-button" onclick="showSection('peerReview')">Peer
				Review Validator</button>
			<span id="peerReview-status" class="status-icon"></span>

			<button class="menu-button" onclick="showSection('impactReport')">Impact
				Report Generator</button>
		</div>

		<div class="content">
			<!-- Change File Generator Section -->
			<div id="changeFile" class="section">
				<div class="right-pane">
					<div class="right-section">
						<h3>Explanation / Summary</h3>
						<p>[Change File usage Content will go here]</p>
						<!-- Report Link -->
						<a id="report-link" href="#" target="_blank"
							style="display: none;">Open Report Folder</a>
						<button id="open-folder-btn" style="display: none;">Open
							Report Folder</button>

					</div>
					<div class="right-section">
						<h3>Utility</h3>
						<form>
							<!-- Dropdown for Last Source File -->
							<label for="last-source-file">Select the Last Source File</label>
							<select id="last-source-file" name="lastSourceFile">
								<!-- Options will be populated dynamically -->
								<option value="">--Select Excel File--</option>
								<!-- Example options (These should be dynamically generated) -->
								<!-- <option value="file1.xlsx">file1.xlsx</option>
        <option value="file2.xlsx">file2.xlsx</option> -->
							</select>

							<!-- Dropdown for Current Week Source File -->
							<label for="current-source-file">Select the Current Week
								Source File</label> <select id="current-source-file"
								name="currentSourceFile">
								<!-- Options will be populated dynamically -->
								<option value="">--Select Excel File--</option>
								<!-- Example options (These should be dynamically generated) -->
								<!-- <option value="file1.xlsx">file1.xlsx</option>
        <option value="file2.xlsx">file2.xlsx</option> -->
							</select>
							<button type="button">Validate</button>
						</form>
						<!-- Flex container to hold both the progress circle and message -->
						<div class="fc-progress-message-container">
							<div class="fc-progress-ring-container">
								<svg class="fc-progress-ring" width="120" height="120">
                <circle class="fc-progress-ring__background"
										stroke="#d3d3d3" stroke-width="8" fill="transparent" r="52"
										cx="60" cy="60" />
                <circle class="fc-progress-ring__circle" stroke="blue"
										stroke-width="8" fill="transparent" r="52" cx="60" cy="60" />
            </svg>
								<span class="fc-progress-ring__text">0%</span>
							</div>

							<div id="fc-message-area"></div>

							<!-- Link to the folder where the report is saved -->
							<a id="report-link" href="file:///C:/Users/Reports/"
								style="display: none;" target="_blank">Open Report Folder</a>
						</div>
					</div>
				</div>
			</div>

			<!-- Peer Review Validator Section -->
			<div id="peerReview" class="section">
				<div class="right-pane">
					<div class="right-section">
						<h3>Explanation / Summary</h3>
						<p>[PR Review validator Content will go here]</p>
					</div>
					<div class="right-section">
						<h3>Utility</h3>
						<form>
							<label for="env-peerReview">Select Env:</label> <select
								id="env-peerReview">
								<option value="SIT">SIT</option>
								<option value="PROD">PROD</option>
							</select> <label for="peerReview-file">Select Change File:</label> <input
								type="file" id="peerReview-file">

							<button type="button" id="validate-btn-src"
								onclick="peerreviewvalidatre() ; validateChangeFile() ">Validate</button>
						</form>
						<div class="progress-message-container">
							<div class="progress-ring-container">
								<svg class="progress-ring" width="120" height="120">
                <circle class="progress-ring__background"
										stroke="#d3d3d3" stroke-width="8" fill="transparent" r="52"
										cx="60" cy="60" />
                <circle class="progress-ring__circle" stroke="blue"
										stroke-width="8" fill="transparent" r="52" cx="60" cy="60" />
            </svg>
								<span class="progress-ring__text">0%</span>
							</div>

							<div id="message-area"></div>

							<!-- Link to the folder where the report is saved -->
							<a id="report-link" href="file:///C:/Users/Reports/"
								style="display: none;" target="_blank">Open Report Folder</a>
						</div>
					</div>
				</div>
			</div>

			<!-- Impact Report Generator Section -->
			<div id="impactReport" class="section">
				<div class="right-pane">
					<div class="right-section">
						<h3>Explanation / Summary</h3>
						<p>[Impact Report Content will go here]</p>
					</div>
					<div class="right-section">
						<h3>Utility</h3>
						<form>
							<label for="env-peerReview">Select Env:</label> <select
								id="env-peerReview">
								<option value="SIT">SIT</option>
								<option value="PROD">PROD</option>
							</select> <label for="peerReview-file">Select Change File:</label> <input
								type="file" id="peerReview-file">

							<button type="button">Validate</button>
						</form>
						<div class="progress-circle">
							<div class="circle">
								<span class="percentage">0%</span>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		function showSection(sectionId) {
			document.querySelectorAll('.section').forEach(function(section) {
				section.style.display = 'none';
			});
			document.getElementById(sectionId).style.display = 'block';
		}
	</script>

	<script src="https://cdn.jsdelivr.net/sockjs/1.0.0/sockjs.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

	<script>
		function comparesrcfiles() {

			const cmpreBtn = document.getElementById('filevalidate-btn');
			const lastSourcefile = document.getElementById('lastSourceFile').files[0];
			const currentSourcefile = document
					.getElementById('currentSourceFile').files[0];
			const fcprogressCircle = document
					.querySelector('.fc_progress-ring__circle');
			const fcprogressText = document
					.querySelector('.fc-progress-ring__text');
			const fcmessageArea = document
					.getElementById('filecompare-message-area');
			const radius = progressCircle.r.baseVal.value;
			const circumference = 2 * Math.PI * radius;

			progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
			progressCircle.style.strokeDashoffset = circumference;

			function setProgress(percent) {
				const offset = circumference - (percent / 100) * circumference;
				progressCircle.style.strokeDashoffset = offset;
				progressText.textContent = `${percent}%`;

				if (percent === 100) {
					resetUIAfterCompletion();
				}
			}

			function resetUIAfterCompletion() {
				lastSourcefile.value = '';
				currentSourcefile.value = '';

				cmpreBtn.disabled = false;
				lastSourcefile.disabled = false;
				currentSourcefile.disabled = false;
			}

			function displayLatestMessage(message) {
				// Make the message area visible if it's hidden
				messageArea.style.display = "block";
				messageArea.textContent = message; // Replace the previous message
			}
			
			function fcnewconnect(){
				const filecomparesocket = new SockJS('/progress-websocket');
				const filecomparestompClient = Stomp.over(filecomparesocket);
				filecomparestompClient.connect({}, function (frame) {
					console.log('Connected: ' + frame);
					filecomparestompClient.subscribe('/fctopic/progress', function (response) {
						const data = response.body.split(":");
						const type = data[0];
						const content = data[1];
						
						if(isCancelled) return ;
						
						if(type === "progress") {
							setProgress(parseInt(content));
						}else if (type === "message"){
							displayLatestMessage(content);
						}
					});
				});
			}

           if(!lastSourcefile || !currentSourcefile){
        	   
        	   alert("Please select both files.");
        	   return;
        	   
           }else {
        	   cmpreBtn.disabled = true;
        	   lastSourcefile.disabled = true ;
        	   currentSourcefile.disabled = true;
        	   fcnewconnect();
        	   
        	   const formData = new FormData();
        	   formData.append("lastSourcefile",lastSourcefile);
        	   formData.append("currentSourcefile",currentSourcefile);
        	   
        	   fetch('/validate-files', {
        		   method: 'POST',
        		   body: formData
        	   }).then(response => response.text()).then(text => {
        		   console.log(text);
        	   }).catch(error => {
        		   console.error("Error: ", error);
        		   resetUIAfterCompletion();
        	   }) 
        	   
        	   
           }
			
		}
	</script>

	<script>
		function peerreviewvalidatre() {

			const validateBtn = document.getElementById('validate-btn-src');
			const changeFileUpload = document.getElementById('peerReview-file');
			const progressCircle = document
					.querySelector('.progress-ring__circle');
			const progressText = document
					.querySelector('.progress-ring__text');
			const messageArea = document
					.getElementById('message-area');
			const radius = progressCircle.r.baseVal.value;
			const circumference = 2 * Math.PI * radius;
		    const fileInput = document.getElementById('peerReview-file');
		    const file = fileInput.files[0];

			progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
			progressCircle.style.strokeDashoffset = circumference;

			function setProgress(percent) {
				const offset = circumference - (percent / 100) * circumference;
				progressCircle.style.strokeDashoffset = offset;
				progressText.textContent = `${percent}%`;

				if (percent === 100) {
					resetUIAfterCompletion();
				}
			}

			function resetUIAfterCompletion() {
				changeFileUpload.value = '';
			
				validateBtn.disabled = false;
				changeFileUpload.disabled = false;

			}

			function displayLatestMessage(message) {
				// Make the message area visible if it's hidden
				messageArea.style.display = "block";
				messageArea.textContent = message; // Replace the previous message
			}
			
			function newconnect(){
				const peersocket = new SockJS('/progress-websocket');
				const peerstompClient = Stomp.over(peersocket);
				peerstompClient.connect({}, function (frame) {
					console.log('Connected: ' + frame);
					peerstompClient.subscribe('/topic/progress', function (response) {
						const data = response.body.split(":");
						const type = data[0];
						const content = data[1];
						
						if(isCancelled) return ;
						
						if(type === "progress") {
							setProgress(parseInt(content));
						}else if (type === "message"){
							displayLatestMessage(content);
						}
					});
				});
			}

           if(!file){
        	   
        	   alert("Please select files.");
        	   return;
        	   
           }else {
        	   validateBtn.disabled = true;
        	   changeFileUpload.disabled = true ;
        	  
        	   newconnect();
        	   
        	   const formData = new FormData();
        	   formData.append("file",file);
        	   
        	   fetch('/validate-excel', {
        		   method: 'POST',
        		   body: formData
        	   }).then(response => response.text()).then(text => {
        		   console.log(text);
        	   }).catch(error => {
        		   console.error("Error: ", error);
        		   resetUIAfterCompletion();
        	   }) 
        	   
        	   
           }
			
		}
	</script>

	<script>
	function validateChangeFile() {
	    // Example validation logic
	    const progressText = document.querySelector("#peerReview .progress-ring__text");
	    const progressCircle = document.querySelector("#peerReview .progress-ring__circle");
	    const messageArea = document.querySelector("#peerReview #message-area");
	    const reportLink = document.querySelector("#peerReview #report-link");
	    const statusIcon = document.querySelector("#peerReview-status-icon"); // Status icon

	    // Reset the progress and status icon
	    progressText.innerText = "0%";
	    const circumference = 2 * Math.PI * 52; // Assuming r=52 from SVG
	    progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
	    progressCircle.style.strokeDashoffset = circumference;
	    statusIcon.classList.remove("visible");

	    let progress = 0;
	    const interval = setInterval(() => {
	        if (progress = 100) {
	            clearInterval(interval);
	            messageArea.innerText = "Validation complete!";
	            reportLink.style.display = "block"; // Show the report link
	            statusIcon.classList.add("visible"); // Show the status icon
	        } else {
	            progress += 10;
	            progressText.innerText = `${progress}%`;
	            const offset = circumference - (progress / 100) * circumference;
	            progressCircle.style.strokeDashoffset = offset;
	        }
	    }, 300); // Simulate progress every 300ms
	}
</script>



</body>
</html>
